/**
 * @OnlyCurrentDoc
 */

// --- è¨­å®šé …ç›® ---
const SHEET_NAME = 'åº—èˆ—ä¸€è¦§';
const HEADER_ROW = 1; // æ—¥ä»˜ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã¯1è¡Œç›®
const DATA_START_ROW = 3; // ãƒ‡ãƒ¼ã‚¿ã¯3è¡Œç›®ã‹ã‚‰
const DATA_START_COLUMN = 3; // ãƒ‡ãƒ¼ã‚¿ãŒå§‹ã¾ã‚‹åˆ—ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ (Cåˆ— = 3)
const DAYS_TO_FETCH = 10; // æœ¬æ—¥ã‹ã‚‰10æ—¥é–“ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—

// ğŸ”§ GitHubè¨­å®š
// â–¼â–¼â–¼ ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‹ã‚‰å€¤ã‚’å–å¾—ã™ã‚‹ã‚ˆã†ã«å¤‰æ›´ â–¼â–¼â–¼
const GITHUB_USERNAME = PropertiesService.getScriptProperties().getProperty('GITHUB_USERNAME');
const GITHUB_TOKEN = PropertiesService.getScriptProperties().getProperty('GITHUB_TOKEN');
// â–²â–²â–² ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‹ã‚‰å€¤ã‚’å–å¾—ã™ã‚‹ã‚ˆã†ã«å¤‰æ›´ â–²â–²â–²
const GITHUB_REPO = 'store-hours-data';
const JSON_FILE_PATH = 'store-hours.json';
const GITHUB_BRANCH = 'main';
// --- è¨­å®šã¯ã“ã“ã¾ã§ ---

/**
 * ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’é–‹ã„ãŸæ™‚ã«ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¿½åŠ ã—ã¾ã™ã€‚
 */
function onOpen(e) {
  SpreadsheetApp.getUi()
    .createMenu('å–¶æ¥­æ™‚é–“æ›´æ–°')
    .addItem('GitHubã«å…¬é–‹', 'pushToGitHub')
    .addToUi();
}

/**
 * ã€æ‰‹å‹•å®Ÿè¡Œç”¨ã€‘ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ã“ã®é–¢æ•°ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚
 * UIã«çµæœã‚’è¡¨ç¤ºã—ã¾ã™ã€‚
 */
function pushToGitHub() {
  updateGitHubJson(true); // æ‰‹å‹•å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰ã§æœ¬ä½“ã®é–¢æ•°ã‚’å‘¼ã³å‡ºã™
}

/**
 * ã€ã‚¿ã‚¤ãƒãƒ¼å®Ÿè¡Œå°‚ç”¨ã€‘ãƒˆãƒªã‚¬ãƒ¼ã‹ã‚‰ã“ã®é–¢æ•°ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚
 * UIæ“ä½œã‚’è¡Œã‚ãšã€ãƒ­ã‚°ã«çµæœã‚’è¨˜éŒ²ã—ã¾ã™ã€‚
 */
function publishToGitHub_forTrigger() {
  updateGitHubJson(false); // è‡ªå‹•å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰ã§æœ¬ä½“ã®é–¢æ•°ã‚’å‘¼ã³å‡ºã™
}

/**
 * GitHubã¸JSONãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã™ã‚‹æœ¬ä½“ã®å‡¦ç†
 * @param {boolean} isManual - æ‰‹å‹•å®Ÿè¡Œã®å ´åˆã¯trueã€è‡ªå‹•å®Ÿè¡Œã®å ´åˆã¯false
 */
function updateGitHubJson(isManual) {
  try {
    const data = getSheetDataAsJson();
    if (!data || data.length === 0) {
      throw new Error('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚');
    }
    const jsonString = JSON.stringify(data, null, 2);

    // 1. GitHubã‹ã‚‰æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã®SHAã‚’å–å¾—
    const getUrl = `https://api.github.com/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/${JSON_FILE_PATH}`;
    const getOptions = {
      method: 'get',
      headers: { 'Authorization': `token ${GITHUB_TOKEN}`, 'Accept': 'application/vnd.github.v3+json' },
      muteHttpExceptions: true
    };
    const getResponse = UrlFetchApp.fetch(getUrl, getOptions);

    let fileSha = null;
    if (getResponse.getResponseCode() === 200) {
      fileSha = JSON.parse(getResponse.getContentText()).sha;
    }

    // 2. ãƒ•ã‚¡ã‚¤ãƒ«ã‚’GitHubã«ä½œæˆã¾ãŸã¯æ›´æ–°
    const putUrl = `https://api.github.com/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/${JSON_FILE_PATH}`;
    const commitMessage = `[${isManual ? 'æ‰‹å‹•' : 'è‡ªå‹•'}æ›´æ–°] å–¶æ¥­æ™‚é–“ãƒ‡ãƒ¼ã‚¿æ›´æ–° - ${new Date().toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' })}`;

    const payload = {
      message: commitMessage,
      content: Utilities.base64Encode(jsonString, Utilities.Charset.UTF_8),
      branch: GITHUB_BRANCH,
      ...(fileSha && { sha: fileSha }) // fileShaãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿shaãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’è¿½åŠ 
    };

    const putOptions = {
      method: 'put',
      headers: {
        'Authorization': `token ${GITHUB_TOKEN}`,
        'Accept': 'application/vnd.github.v3+json',
        'Content-Type': 'application/json'
      },
      payload: JSON.stringify(payload),
      muteHttpExceptions: true
    };

    const putResponse = UrlFetchApp.fetch(putUrl, putOptions);
    const responseCode = putResponse.getResponseCode();

    // 3. çµæœã‚’é€šçŸ¥ï¼ˆæ‰‹å‹•ã‹è‡ªå‹•ã‹ã§æ–¹æ³•ã‚’åˆ†å²ï¼‰
    if (responseCode === 200 || responseCode === 201) {
      const successMessage = 'GitHubã¸ã®å…¬é–‹ã«æˆåŠŸã—ã¾ã—ãŸã€‚';
      if (isManual) {
        const publicURL = `https://${GITHUB_USERNAME}.github.io/${GITHUB_REPO}/${JSON_FILE_PATH}`;
        SpreadsheetApp.getUi().alert(`âœ… ${successMessage}\n\nå…¬é–‹URLï¼ˆæ•°åˆ†å¾Œã«åæ˜ ï¼‰:\n${publicURL}`);
      } else {
        console.log(successMessage); // è‡ªå‹•å®Ÿè¡Œæ™‚ã¯ãƒ­ã‚°ã«å‡ºåŠ›
      }
    } else {
      const errorMessage = `GitHubã¸ã®å…¬é–‹ã«å¤±æ•—ã—ã¾ã—ãŸ: ${putResponse.getContentText()}`;
      if (isManual) {
        SpreadsheetApp.getUi().alert(`âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:\n${errorMessage}`);
      } else {
        console.error(errorMessage); // è‡ªå‹•å®Ÿè¡Œæ™‚ã¯ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã«å‡ºåŠ›
      }
    }
  } catch (e) {
    const errorMessage = `å®Ÿè¡Œä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${e.message}`;
    if (isManual) {
      SpreadsheetApp.getUi().alert(`âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:\n${errorMessage}`);
    } else {
      console.error(errorMessage); // è‡ªå‹•å®Ÿè¡Œæ™‚ã¯ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã«å‡ºåŠ›
    }
  }
}

// --- ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ»åŠ å·¥ç”¨ã®é–¢æ•° ---

function getSheetDataAsJson() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAME);
  if (!sheet) throw new Error(`ã‚·ãƒ¼ãƒˆåã€Œ${SHEET_NAME}ã€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚`);

  // ãƒ‡ãƒ¼ã‚¿ç¯„å›²ã‚’èª¿æ•´: DATA_START_COLUMN ã‹ã‚‰æœ€çµ‚åˆ—ã¾ã§ã‚’å–å¾—
  const lastColumn = sheet.getLastColumn();
  const range = sheet.getRange(1, 1, sheet.getLastRow(), lastColumn);
  const allData = range.getValues();

  // ãƒ˜ãƒƒãƒ€ãƒ¼ (1è¡Œç›®)
  const headers = allData[HEADER_ROW - 1];
  // ãƒ‡ãƒ¼ã‚¿éƒ¨ (DATA_START_ROWä»¥é™)
  const storesData = allData.slice(DATA_START_ROW - 1);

  // â–¼â–¼â–¼ åŸºæº–æ—¥ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆ7:00ãƒ­ãƒ¼ãƒ«ã‚ªãƒ¼ãƒãƒ¼ï¼‰ â–¼â–¼â–¼
  const now = new Date();
  if (now.getHours() < 7) {
    now.setDate(now.getDate() - 1);
  }
  const today = now;
  // â–²â–²â–²

  today.setHours(0, 0, 0, 0);
  const currentYear = today.getFullYear();
  const currentMonth = today.getMonth();

  const dateColumns = [];

  // æ—¥ä»˜ã®é–‹å§‹åˆ—: Låˆ— = index 11
  // DATA_START_COLUMN = 3 (Cåˆ—), +8 = 11
  const DATE_START_COL_INDEX = DATA_START_COLUMN + 8; // Låˆ—ã‹ã‚‰é–‹å§‹

  for (let i = DATE_START_COL_INDEX; i < headers.length; i++) {
    const headerValue = headers[i];
    if (!headerValue) continue;

    let headerDate = null;
    if (headerValue instanceof Date) {
      headerDate = new Date(headerValue);
    } else if (typeof headerValue === 'string') {
      const matches = headerValue.trim().match(/(\d{1,2})æœˆ(\d{1,2})æ—¥/);
      if (matches) {
        const month = parseInt(matches[1], 10) - 1;
        const day = parseInt(matches[2], 10);
        // å¹´åº¦ã®è‡ªå‹•è£œæ­£
        const year = (currentMonth === 11 && month === 0) ? currentYear + 1 : currentYear;
        headerDate = new Date(year, month, day);
      }
    }

    if (headerDate) {
      headerDate.setHours(0, 0, 0, 0);
      const daysDiff = Math.floor((headerDate.getTime() - today.getTime()) / (1000 * 60 * 60 * 24));
      if (daysDiff >= 0 && daysDiff < DAYS_TO_FETCH) {
        dateColumns.push({
          date: Utilities.formatDate(headerDate, 'JST', 'yyyy-MM-dd'),
          weekday: ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'][headerDate.getDay()],
          openIndex: i,
          closeIndex: i + 1,
          sortOrder: daysDiff
        });
      }
    }
  }
  dateColumns.sort((a, b) => a.sortOrder - b.sortOrder);

  const result = [];
  for (let i = 0; i < storesData.length; i++) {
    const currentRow = storesData[i];
    // åº—èˆ—IDã¯DATA_START_COLUMNã‹ã‚‰æ•°ãˆã¦0ç•ªç›® (index 2)
    const numericId = parseInt(currentRow[DATA_START_COLUMN - 1], 10);

    if (isNaN(numericId)) continue;

    // æ¬¡ã®è¡Œã®åº—èˆ—IDåˆ—ãŒç©ºæ¬„ãªã‚‰ã€ãã®è¡Œã¯ç¾åœ¨ã®åº—èˆ—ã®è¿½åŠ å–¶æ¥­æ™‚é–“ã¨è¦‹ãªã™
    let nextRow = null;
    if (i + 1 < storesData.length && !storesData[i + 1][DATA_START_COLUMN - 1]) {
      nextRow = storesData[i + 1];
    }

    const days = dateColumns.map(col => {
      const hours = [];
      const openTime1 = formatAndNormalizeTime(currentRow[col.openIndex], false);
      const closeTime1 = formatAndNormalizeTime(currentRow[col.closeIndex], true);
      if (openTime1 && closeTime1) {
        hours.push({ open: openTime1, close: closeTime1 });
      }

      if (nextRow) {
        const openTime2 = formatAndNormalizeTime(nextRow[col.openIndex], false);
        const closeTime2 = formatAndNormalizeTime(nextRow[col.closeIndex], true);
        if (openTime2 && closeTime2) {
          hours.push({ open: openTime2, close: closeTime2 });
        }
      }

      const status = hours.length > 0 ? 'open' : 'holiday';

      const dayData = {
        date: col.date,
        weekday: col.weekday,
        status: status,
      };

      if (status === 'open') {
        dayData.hours = hours;
      }
      return dayData;
    });

    result.push({
      store: {
        id: `store_${numericId}`,
        numericId: numericId,
        // â–¼â–¼â–¼ åˆ—ãƒãƒƒãƒ”ãƒ³ã‚° (Screenshotæœ€æ–°ç‰ˆæº–æ‹ ) â–¼â–¼â–¼
        // Cåˆ—(idx 2): åº—èˆ—ID
        // Dåˆ—(idx 3): å€‹åº—URL
        // Eåˆ—(idx 4): åº—å (JP)
        // Fåˆ—(idx 5): ä½æ‰€ (JP)
        // Gåˆ—(idx 6): åœ°åŸŸ
        // Håˆ—(idx 7): éƒ½é“åºœçœŒ (æœªä½¿ç”¨)
        // Iåˆ—(idx 8): åŒºå¸‚ç”ºæ‘ (æœªä½¿ç”¨)
        // Jåˆ—(idx 9): name_en
        // Kåˆ—(idx 10): prefecture_en

        url: String(currentRow[DATA_START_COLUMN]),          // Dåˆ—(idx 3)
        name: String(currentRow[DATA_START_COLUMN + 1]),     // Eåˆ—(idx 4)
        name_en: String(currentRow[DATA_START_COLUMN + 6]),  // Jåˆ—(idx 9)
        prefecture: String(currentRow[DATA_START_COLUMN + 2]), // Fåˆ—(idx 5)
        prefecture_en: String(currentRow[DATA_START_COLUMN + 7]), // Kåˆ—(idx 10)
        region: mapRegionToId(currentRow[DATA_START_COLUMN + 3]), // Gåˆ—(idx 6)
      },
      range: {
        from: dateColumns.length > 0 ? dateColumns[0].date : Utilities.formatDate(today, 'JST', 'yyyy-MM-dd'),
        days: dateColumns.length,
        tz: 'Asia/Tokyo',
        rollover_at: '07:00',
      },
      days: days,
      updatedAt: new Date().toISOString(),
    });

    if (nextRow) {
      i++;
    }
  }
  return result;
}

/**
 * ã‚³ãƒ­ãƒ³ä¸å‚™ãªã©ã‚’æ­£è¦åŒ–
 */
function formatAndNormalizeTime(timeInput, isCloseTime = false) {
  if (timeInput == null || timeInput === '') return '';

  let timeStr;

  if (timeInput instanceof Date) {
    timeStr = Utilities.formatDate(timeInput, 'Asia/Tokyo', 'HH:mm');
  } else {
    timeStr = String(timeInput).trim();
    if (/[ä¼‘-]/.test(timeStr)) return '';

    timeStr = timeStr
      .replace(/o/gi, '0')
      .replace(/[()]/g, '')
      .replace(/[ï¼¡-ï¼ºï½-ï½šï¼-ï¼™ï¼ï¼šï¼›ï¼Œã€ãƒ»ï½¥]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0))
      .replace(/[.;,ã€ï¼Œãƒ»ï½¥]/g, ':')
      .replace(/:+/g, ':')
      .replace(/^:|:$/g, '');

    const onlyDigits = timeStr.replace(/\D/g, '');
    if ((/^\d{3,4}$/.test(onlyDigits)) && !timeStr.includes(':')) {
      timeStr = onlyDigits.slice(0, -2) + ':' + onlyDigits.slice(-2);
    } else if (timeStr.includes(':')) {
      const parts = timeStr.split(':').filter(Boolean);
      if (parts.length >= 2) {
        let h = parts[0], m = parts[1];
        if (/^\d$/.test(m)) m = '0' + m;
        timeStr = `${h}:${m}`;
      } else {
        if (/^\d{3,4}$/.test(onlyDigits)) {
          timeStr = onlyDigits.slice(0, -2) + ':' + onlyDigits.slice(-2);
        } else {
          return '';
        }
      }
    } else {
      return '';
    }
  }

  if (!/^\d{1,2}:\d{2}$/.test(timeStr)) return '';

  const [hStr, mStr] = timeStr.split(':');
  let hour = parseInt(hStr, 10);
  let minute = parseInt(mStr, 10);
  if (Number.isNaN(hour) || Number.isNaN(minute)) return '';
  if (minute < 0 || minute > 59) return '';

  if (isCloseTime && hour >= 0 && hour <= 7) {
    hour += 24;
  }

  return `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
}

function mapRegionToId(regionName) {
  const regionMap = {
    'åŒ—æµ·é“': 'hokkaido',
    'æ±åŒ—': 'tohoku',
    'é–¢æ±': 'kanto',
    'ä¸­éƒ¨': 'chubu',
    'è¿‘ç•¿': 'kinki',
    'é–¢è¥¿': 'kinki',
    'ä¹å·': 'kyushu',
    // å¿…è¦ã«å¿œã˜ã¦ä»–ã®åœ°åŸŸã‚’è¿½åŠ 
  };
  return regionMap[regionName] || null;
}